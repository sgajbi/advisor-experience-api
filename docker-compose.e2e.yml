services:
  dpm-postgres:
    image: postgres:17.6
    environment:
      POSTGRES_DB: dpm_supportability
      POSTGRES_USER: dpm
      POSTGRES_PASSWORD: dpm
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dpm -d dpm_supportability"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  dpm:
    build:
      context: ${DPM_REPO_PATH}
      dockerfile: Dockerfile
    environment:
      ENVIRONMENT: production
      APP_PERSISTENCE_PROFILE: PRODUCTION
      DPM_SUPPORTABILITY_STORE_BACKEND: POSTGRES
      DPM_SUPPORTABILITY_POSTGRES_DSN: postgresql://dpm:dpm@dpm-postgres:5432/dpm_supportability
      PROPOSAL_STORE_BACKEND: POSTGRES
      PROPOSAL_POSTGRES_DSN: postgresql://dpm:dpm@dpm-postgres:5432/dpm_supportability
      DPM_POLICY_PACK_CATALOG_BACKEND: POSTGRES
      DPM_POLICY_PACK_POSTGRES_DSN: postgresql://dpm:dpm@dpm-postgres:5432/dpm_supportability
    depends_on:
      dpm-postgres:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/integration/capabilities?consumerSystem=BFF&tenantId=default', timeout=5)"
        ]
      interval: 20s
      timeout: 5s
      retries: 15
      start_period: 20s

  pas-postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: portfolio_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d portfolio_db"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  pas-migration-runner:
    build:
      context: ${PAS_REPO_PATH}
      dockerfile: ./src/services/persistence_service/Dockerfile
    environment:
      DATABASE_URL: postgresql://user:password@pas-postgres:5432/portfolio_db
    depends_on:
      pas-postgres:
        condition: service_healthy
    command: ["alembic", "upgrade", "head"]
    restart: "no"

  pas-query:
    build:
      context: ${PAS_REPO_PATH}
      dockerfile: ./src/services/query_service/Dockerfile
    environment:
      DATABASE_URL: postgresql://user:password@pas-postgres:5432/portfolio_db
    depends_on:
      pas-migration-runner:
        condition: service_completed_successfully
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8001"]
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8001/integration/capabilities?consumerSystem=BFF&tenantId=default', timeout=5)"
        ]
      interval: 20s
      timeout: 5s
      retries: 15
      start_period: 20s

  pa:
    image: python:3.12-slim
    working_dir: /app
    volumes:
      - ${PA_REPO_PATH}:/app
    command:
      [
        "sh",
        "-lc",
        "pip install --no-cache-dir -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8000"
      ]
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/integration/capabilities?consumerSystem=BFF&tenantId=default', timeout=5)"
        ]
      interval: 20s
      timeout: 5s
      retries: 20
      start_period: 30s

  ras:
    build:
      context: ${RAS_REPO_PATH}
      dockerfile: Dockerfile
    environment:
      PAS_BASE_URL: http://pas-query:8001
      PA_BASE_URL: http://pa:8000
      UPSTREAM_TIMEOUT_SECONDS: 10
      CONTRACT_VERSION: v1
    depends_on:
      pas-query:
        condition: service_healthy
      pa:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8300/integration/capabilities?consumerSystem=BFF&tenantId=default', timeout=5)"
        ]
      interval: 20s
      timeout: 5s
      retries: 20
      start_period: 30s

  bff:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      DECISIONING_SERVICE_BASE_URL: http://dpm:8000
      PORTFOLIO_DATA_PLATFORM_BASE_URL: http://pas-query:8001
      PERFORMANCE_ANALYTICS_BASE_URL: http://pa:8000
      REPORTING_AGGREGATION_BASE_URL: http://ras:8300
      UPSTREAM_TIMEOUT_SECONDS: 10
      CONTRACT_VERSION: v1
    ports:
      - "8100:8100"
    depends_on:
      dpm:
        condition: service_healthy
      pas-query:
        condition: service_healthy
      pa:
        condition: service_healthy
      ras:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8100/health', timeout=5)"
        ]
      interval: 20s
      timeout: 5s
      retries: 15
      start_period: 15s
